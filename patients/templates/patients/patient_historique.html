{% extends "patients/patient_dashboard.html" %}
{% load static %}

{% block dashboard_title %}Historique Complet{% endblock %}
{% block main_title %}Mon Historique Médical{% endblock %}

{% block dashboard_content %}
    
    <div class="row">
        <div class="col-lg-12">
            
            <ul class="nav nav-tabs nav-fill mb-4" id="historiqueTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fw-bold" id="suivis-tab" data-bs-toggle="tab" data-bs-target="#suivis" type="button" role="tab" aria-controls="suivis" aria-selected="true">
                        Suivis Cliniques ({{ historique_suivis|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold" id="rdv-tab" data-bs-toggle="tab" data-bs-target="#rdv" type="button" role="tab" aria-controls="rdv" aria-selected="false">
                        Rendez-vous ({{ historique_rdv|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold" id="releves-tab" data-bs-toggle="tab" data-bs-target="#releves" type="button" role="tab" aria-controls="releves" aria-selected="false">
                        Relevés Vitaux ({{ historique_releves|length }})
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="historiqueTabsContent">
                
                <div class="tab-pane fade show active" id="suivis" role="tabpanel" aria-labelledby="suivis-tab">
                    {% if historique_suivis %}
                        <div class="list-group">
                            {% for suivi in historique_suivis %}
                                <div class="list-group-item list-group-item-action mb-3 p-4 shadow-sm rounded-3">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1 text-primary fw-bold">{{ suivi.motif }}</h5>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> Le {{ suivi.date_suivi|date:"d F Y" }}
                                            à {{ suivi.date_suivi|date:"H:i" }}
                                        </small>
                                    </div>
                                    <p class="mb-1 mt-2 small text-dark">
                                        **Observations du médecin :** {{ suivi.notes_medecin|truncatechars:150 }}
                                    </p>
                                    {% if suivi.prescriptions %}
                                        <small class="text-success fw-bold">Prescriptions incluses</small>
                                    {% else %}
                                        <small class="text-secondary">Pas de prescription</small>
                                    {% endif %}
                                    
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary float-end btn-details-suivi"
                                            data-bs-toggle="modal"
                                            data-bs-target="#suiviDetailModal"
                                            data-motif="{{ suivi.motif }}"
                                            data-date="{{ suivi.date_suivi|date:'d F Y à H:i' }}"
                                            data-notes="{{ suivi.notes_medecin }}"
                                            data-prescriptions="{{ suivi.prescriptions|default:'Aucune prescription enregistrée.' }}">
                                        Voir Détails
                                    </button>
                                    </div>
                            {% endfor %}
                        </div>
                    {% else %}
                    {% endif %}
                </div>

                </div>
                
                <div class="tab-pane fade" id="rdv" role="tabpanel" aria-labelledby="rdv-tab">
                    
                    {% if historique_rdv %}
                        <ul class="list-group list-group-flush">
                            {% for rdv in historique_rdv %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="me-auto">
                                        <h6 class="mb-1 fw-bold">{{ rdv.motif }}</h6>
                                        <p class="mb-1 small text-dark">
                                            <i class="bi bi-clock-history"></i> Date: {{ rdv.date_heure|date:"d F Y à H:i" }}
                                        </p>
                                    </div>
                                    <span class="badge 
                                        {% if rdv.statut == 'C' %}bg-success
                                        {% elif rdv.statut == 'P' %}bg-warning text-dark
                                        {% elif rdv.statut == 'A' %}bg-danger
                                        {% else %}bg-secondary
                                        {% endif %} 
                                        rounded-pill p-2 fw-bold">
                                        {{ rdv.get_statut_display }} </span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-info">Aucun rendez-vous planifié ou passé enregistré.</div>
                    {% endif %}

                </div>

                <div class="tab-pane fade" id="releves" role="tabpanel" aria-labelledby="releves-tab">
                    
                    {% if historique_releves %}
                        <table class="table table-striped table-hover shadow-sm">
                            <thead class="table-success">
                                <tr>
                                    <th>Date et Heure</th>
                                    <th>Tension (Sys/Dia)</th>
                                    <th>Glycémie (g/L)</th>
                                    <th>Poids (kg)</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for releve in historique_releves %}
                                    <tr>
                                        <td class="small">{{ releve.date_releve|date:"d/m/Y H:i" }}</td>
                                        <td class="fw-bold">
                                            {{ releve.tension_systolique|default:"N/A" }}/{{ releve.tension_diastolique|default:"N/A" }}
                                        </td>
                                        <td>{{ releve.glycemie|default:"N/A" }}</td>
                                        <td>{{ releve.poids|default:"N/A" }}</td>
                                        <td class="small text-muted">{{ releve.notes_patient|default:"-"|truncatechars:50 }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="alert alert-info">Aucun relevé de télésurveillance enregistré.</div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="suiviDetailModal" tabindex="-1" aria-labelledby="suiviDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="suiviDetailModalLabel">Détails du Suivi - <span id="modalMotif"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">
                        <i class="bi bi-calendar-event me-2"></i> Date du suivi : <span id="modalDate" class="fw-bold text-dark"></span>
                    </p>
                    
                    <h6 class="fw-bold text-dark border-bottom pb-2 mt-3">Observations du Soignant</h6>
                    <div class="alert alert-secondary" id="modalNotes">
                        </div>
                    
                    <h6 class="fw-bold text-dark border-bottom pb-2 mt-4">Prescriptions</h6>
                    <div class="alert alert-success" id="modalPrescriptions">
                        </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>


{% endblock dashboard_content %}



{% block extra_js %}
    {{ block.super }}

    <script>
        // Attendre que le document soit prêt
        document.addEventListener('DOMContentLoaded', function() {
            // Cibler tous les boutons de détails de suivi
            const detailButtons = document.querySelectorAll('.btn-details-suivi');
            const modalElement = document.getElementById('suiviDetailModal');
            
            // Écouter l'événement 'show.bs.modal' qui se déclenche juste avant l'ouverture de la modale
            modalElement.addEventListener('show.bs.modal', function (event) {
                // Bouton qui a déclenché la modale
                const button = event.relatedTarget;
                
                // Extraction des données des attributs data-*
                const motif = button.getAttribute('data-motif');
                const date = button.getAttribute('data-date');
                const notes = button.getAttribute('data-notes');
                const prescriptions = button.getAttribute('data-prescriptions');
                
                // Mise à jour du contenu de la modale
                const modalMotif = modalElement.querySelector('#modalMotif');
                const modalDate = modalElement.querySelector('#modalDate');
                const modalNotes = modalElement.querySelector('#modalNotes');
                const modalPrescriptions = modalElement.querySelector('#modalPrescriptions');

                // Injection des données
                modalMotif.textContent = motif;
                modalDate.textContent = date;
                modalNotes.innerHTML = notes.replace(/\n/g, '<br>'); // Remplace les retours à la ligne par <br>
                modalPrescriptions.innerHTML = prescriptions.replace(/\n/g, '<br>');

                // Rendre le bloc prescription plus visible si des données existent
                if (prescriptions === 'Aucune prescription enregistrée.') {
                    modalPrescriptions.classList.remove('alert-success');
                    modalPrescriptions.classList.add('alert-secondary');
                } else {
                    modalPrescriptions.classList.remove('alert-secondary');
                    modalPrescriptions.classList.add('alert-success');
                }
            });
        });
    </script>
{% endblock extra_js %}